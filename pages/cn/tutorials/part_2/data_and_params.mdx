---
title: "数据流与参数绑定机制：变量如何在 Pipeline 中传递？"
icon: "square-terminal"
---

在 UltraRAG 中，pipeline 是通过变量名进行数据绑定的：每个工具（Tool）在注册时会声明自己的输入参数名和输出变量名，而 pipeline 中的每一步执行，都是通过这些变量名完成传参和数据流动的。

这一机制简单直接，但在多轮调用、复杂控制结构（如 loop 或 branch）中，会带来一些变量名冲突或重名绑定的问题。为解决此问题，UltraRAG 提供了 参数重写机制（参数重命名），使得你可以灵活控制数据在 pipeline 中的流动。

## 数据如何流动？

每个工具在 Server 中注册时，都指定了其输入和输出变量名。例如：

```python
mcp_inst.tool(
    self.retriever_search,
    output="q_ls,top_k->ret_psg",
)
```

含义是：

- 工具接收两个输入变量 q_ls 和 top_k
- 工具输出变量名为 ret_psg

在最简单的串行 pipeline 中，这种默认绑定没有问题。但如果你在循环或分支中 多次调用 retriever_search，希望传入不同的数据（比如第一次叫 q_ls，第二次叫 sub_q_ls），那你就需要一个方法来 告诉 pipeline：这些变量其实是“同义词”。

## 参数重命名机制

为了解决上述变量名绑定冲突，UltraRAG 提供了如下机制：

UltraRAG 支持在 pipeline.yaml 中 使用 input: 和 output: 明确重命名传参与变量映射，而无需修改 server 中的代码。

基本语法

```yaml
- module.tool:
    input:
      tool_param_name: actual_variable_name
    output:
      actual_variable_name
- tool_param_name: 工具注册时写死的参数名
- actual_variable_name: 当前 pipeline 中可用的变量名
- output: 允许你将工具输出重命名为任意 pipeline 中新变量名
```

## 示例1：输入变量重命名

```yaml
- retriever.retriever_search:
    input:
      q_ls: sub_q_ls
```

说明：retriever_search 原本期望名为 q_ls 的输入参数，现在你用的是变量 sub_q_ls，通过这条语句做了参数映射，无需修改 server 中的代码。

## 示例2：输出变量重命名

```yaml
- retriever.retriever_search:
    output: round1_result
```

说明：无论工具原本输出变量名叫什么（例如 ret_psg），现在都将其绑定为 round1_result，用于 pipeline 后续步骤引用。

例如：

```yaml
- prompt.qa_rag_boxed:
    input:
      ret_psg: round1_result
```

`qa_rag_boxed` 工具注册时期望一个输入参数 ret_psg，此处我们用 input: 显式将上一阶段的 round1_result 映射为它的 ret_psg，实现数据绑定。

## 示例3：同时重写输入输出

```yaml
- retriever.retriever_search:
    input:
      q_ls: round1_query
    output: round1_result
```

这个模式在 loop 中非常常见，每轮检索都用新的变量名。

有了参数重写机制，你可以在不修改工具源码的前提下，灵活组合与复用任何 Server 提供的 Tool，让 UltraRAG 的 pipeline 更具扩展性与可控性。