---
title: "Corpus Embedding and Indexing"
icon: "file-magnifying-glass"
---

In practical applications, RAG systems often need to perform efficient retrieval over millions or even tens of millions of documents. To support large-scale semantic search, UltraRAG allows you to embed (encode) raw corpora and build efficient indexes.

This section introduces how to write a corresponding UltraRAG pipeline and complete the embedding and indexing process for your corpus.

## Step 1: Write the Pipeline YAML File

Create a new YAML file under the `examples/` directory (such as `corpus_index.yaml`) with the following content:

```yaml
# MCP Server
servers:
  retriever: servers/retriever

# MCP Client Pipeline
pipeline:
- retriever.retriever_init
- retriever.retriever_embed
- retriever.retriever_index
```

## Step 2: Build the Pipeline and Configure Parameters

Run the following command to build the pipeline:

```shell
ultrarag build examples/corpus_index.yaml
```

A parameter configuration file will then be generated. You can modify the relevant fields as needed. For example:

```yaml
retriever:
  corpus_path: data/sample_hotpotqa_corpus_5.jsonl       # Input corpus path (JSONL format)
  retriever_path: openbmb/MiniCPM-Embedding-Light        # Retriever model name or path
  embedding_path: embedding/embedding.npy                # Path to save embeddings
  index_path: index/index.index                          # Path to save index file
  faiss_use_gpu: true                                    # Enable GPU acceleration or not
  index_chunk_size: 50000                                # Chunk size for building index
  cuda_devices: 0,1                                      # GPU device IDs to use
  overwrite: false                                       # Overwrite existing files or not
  infinity_kwargs:                                       # Embedding engine configuration
    batch_size: 1024
    bettertransformer: false
    device: cuda
    pooling_method: auto
```

## Step 3: Run the Pipeline for Embedding and Indexing

Run the following command to process the corpus:

```shell
ultrarag run examples/corpus_index.yaml
```

ðŸ“Œ Tip: Since the embedding and indexing process may involve a large corpus and take a long time, it is recommended to use `screen` or `nohup` to run the task in the background. For example:

```shell
nohup ultrarag run examples/corpus_index.yaml > log.txt 2>&1 &
```