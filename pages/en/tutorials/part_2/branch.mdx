---
title: "Branching Structure"
icon: "code-branch"
---

In complex reasoning tasks, we often need to decide whether to continue the workflow based on the model's current output or intermediate state. For example:

- If the model generates a query, proceed to the next round of retrieval;
- If the model has generated the final answer, end the workflow.

To achieve this, UltraRAG provides the **branch** structure, which is used to build dynamic reasoning workflows with conditional jumping logic.
> âœ… The Router Server is the partner of the branching structure. It is responsible for judging the current state and returning a status label, which drives the workflow direction.
>
> If you are not yet familiar with how to implement a Router Tool, please refer to: **Router Server Tutorial: Using Router Tool to Control Branch Logic**

## Example: Dynamically Decide Whether to Enter the Next Retrieval Round

The following pipeline will, after each generation, determine whether the current generated content is a query or the final answer. If it's a query, it performs another round of retrieval and generation; otherwise, the workflow ends.

```yaml
servers:
  router: servers/router
  ...

pipeline:
  - benchmark.get_data
  - retriever.retriever_init

  - prompt.generate_query_or_answer
  - generation.generate

  - loop:
      times: 3         
      steps:
      - branch:
          router:
            - router.check_query_or_answer   # Output e.g. status=is_query/is_answer
          branches:
            is_query:
              - retriever.retriever_search
              - prompt.generate_query_or_answer
              - generation.generate

            is_answer: []    # is_answer outputs the answer

  - evaluation.evaluate
```

## Explanation

- **branch**: Marks the start of a branching structure.
- **router**: Specifies the Router Tool used to determine the branch logic (usually returns a status label such as `is_query` / `is_answer`).
- **branches**: Defines the sequence of steps to execute for each state. The keys are status labels, and the values are the corresponding step lists (empty means terminate).
- The keys defined in **branches** must match the `state` value returned by the Router tool.

With the branching structure, UltraRAG not only supports flexible composition of multi-turn workflows, but also enables dynamic judgment and strategy control, allowing you to build truly "controllable" and "reasoning-capable" RAG systems.